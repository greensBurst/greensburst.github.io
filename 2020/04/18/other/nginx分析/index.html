<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="李素晴"><meta name="copyright" content="李素晴"><meta name="generator" content="Hexo 5.1.1"><meta name="theme" content="hexo-theme-yun"><title>nginx分析 | Lisuqing's Personal Website</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.21/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_2138379_1l6ur2tg9f2.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/photo/icon.png"><link rel="mask-icon" href="/photo/icon.png" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"lisuqing2020.github.io","root":"/","title":"李素晴的日记","version":"1.2.0","mode":"time","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><script data-ad-client="ca-pub-9695375546022807" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><meta name="description" content="nginx多进程同步非阻塞并发模型分析 基于epoll-et事件驱动模型非阻塞处理并发请求，让nginx成为当下最流行的轻量级web服务器，其在性能方面远胜于同类型其他产品，通过IO多路复用机制实现并发，这使得nginx的网络IO操作在单个具体处理流程中是同步的，并不是真正意义上的UNIX IO模型中的AIO。本文通过分析nginx的内部实现机制，尝试寻找基于现有nginx网络架构基础上，进行">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx分析">
<meta property="og:url" content="http://lisuqing2020.github.io/2020/04/18/other/nginx%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Lisuqing&#39;s Personal Website">
<meta property="og:description" content="nginx多进程同步非阻塞并发模型分析 基于epoll-et事件驱动模型非阻塞处理并发请求，让nginx成为当下最流行的轻量级web服务器，其在性能方面远胜于同类型其他产品，通过IO多路复用机制实现并发，这使得nginx的网络IO操作在单个具体处理流程中是同步的，并不是真正意义上的UNIX IO模型中的AIO。本文通过分析nginx的内部实现机制，尝试寻找基于现有nginx网络架构基础上，进行">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-04-18T02:08:32.000Z">
<meta property="article:modified_time" content="2020-11-22T05:30:19.372Z">
<meta property="article:author" content="李素晴">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="李素晴"><img width="96" loading="lazy" src="/photo/avatar.jpg" alt="李素晴"></a><div class="site-author-name"><a href="/about/">李素晴</a></div><a class="site-name" href="/about/site.html">Lisuqing's Personal Website</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">227</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder--line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag--line"></use></svg></span><span class="site-state-item-count">21</span></a></div><a class="site-state-item hty-icon-button" href="/about" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=1164919034&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/lisuqing2020" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:lisuqing2020@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://juejin.im/user/676954896099847" title="掘金" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-juejin"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" target="_blank" rel="noopener" href="https://nobilta.github.io/" title="东农吴彦祖" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" target="_blank" rel="noopener" href="https://happycpp.github.io/" title="渣王" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">nginx多进程同步非阻塞并发模型分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%EF%BC%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E6%A0%B8CPU"><span class="toc-number">1.1.</span> <span class="toc-text">一．多进程与多核CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%B9%B6%E5%8F%91"><span class="toc-number">1.1.1.</span> <span class="toc-text">（一）并行与并发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89master%E4%B8%8Eworker"><span class="toc-number">1.1.2.</span> <span class="toc-text">（二）master与worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">（三）处理流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8E%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">二．事件驱动架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89select"><span class="toc-number">1.2.1.</span> <span class="toc-text">（一）select</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89poll"><span class="toc-number">1.2.2.</span> <span class="toc-text">（二）poll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89epoll"><span class="toc-number">1.2.3.</span> <span class="toc-text">（三）epoll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89epoll%E4%B8%8Eselect%E3%80%81poll%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.4.</span> <span class="toc-text">（四）epoll与select、poll对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%EF%BC%8E%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BC%82%E6%AD%A5"><span class="toc-number">1.3.</span> <span class="toc-text">三．同步与异步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8E%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">四．总结</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://lisuqing2020.github.io/2020/04/18/other/nginx%E5%88%86%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="李素晴"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Lisuqing's Personal Website"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">nginx分析</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2020-04-18 10:08:32" itemprop="dateCreated datePublished" datetime="2020-04-18T10:08:32+08:00">2020-04-18</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2020-11-22 13:30:19" itemprop="dateModified" datetime="2020-11-22T13:30:19+08:00">2020-11-22</time></div><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-tag"><a class="tag" href="/tags/nginx/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">nginx</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><a id="more"></a>

<h1 id="nginx多进程同步非阻塞并发模型分析"><a href="#nginx多进程同步非阻塞并发模型分析" class="headerlink" title="nginx多进程同步非阻塞并发模型分析"></a>nginx多进程同步非阻塞并发模型分析</h1><blockquote>
<p>基于epoll-et事件驱动模型非阻塞处理并发请求，让nginx成为当下最流行的轻量级web服务器，其在性能方面远胜于同类型其他产品，通过IO多路复用机制实现并发，这使得nginx的网络IO操作在单个具体处理流程中是同步的，并不是真正意义上的UNIX IO模型中的AIO。本文通过分析nginx的内部实现机制，尝试寻找基于现有nginx网络架构基础上，进行异步IO的方式。</p>
</blockquote>
<h2 id="一．多进程与多核CPU"><a href="#一．多进程与多核CPU" class="headerlink" title="一．多进程与多核CPU"></a>一．多进程与多核CPU</h2><h3 id="（一）并行与并发"><a href="#（一）并行与并发" class="headerlink" title="（一）并行与并发"></a>（一）并行与并发</h3><ul>
<li>假设办公室内只有一台咖啡机，午休时大家排成一列队伍，每个人在自己的杯子里接满咖啡后，回到座位上慢慢享用。这个过程叫做串行。<br>同样的，办公室依旧只有一台咖啡机，大家依旧排成一列队伍，每个人只在自己的杯子里接一部分的咖啡，然后回到座位上将杯子中的咖啡喝光，继续排在队伍的后面，这个过程叫做并发。</li>
<li>而如果办公室内有两台咖啡机，大家就可以排成两列一样长的队伍，这两列队伍依旧按照并发处理，这个过程叫做并行。并行是需要硬件作为支撑的。<br>也就是说，如果计算机的cpu是单核的，那么在一个时间点内，cpu不可能同时处理多个进程，每个进程只能占用cpu资源一段时间。但如果cpu是多核的，当计算机中有多个进程需要处理，那么不同的两个进程之间就有可能是并行的。</li>
<li>nginx的架构设计默认采用多进程的方式，分为单个master进程和多个worker进程，其中worker进程的数量一般与cpu核数保持一致，基于这样的设置，使得nginx可以充分利用cpu资源，在硬件的层面上提升了服务器性能。<h3 id="（二）master与worker"><a href="#（二）master与worker" class="headerlink" title="（二）master与worker"></a>（二）master与worker</h3></li>
<li>unix系统中，nginx启动后以守护进程的形式在后台运行，整个nginx服务包含一个master进程和多个worker进程，nginx同样支持多线程模式，考虑到多线程模式的线程安全问题，我们一般就采用nginx默认的多进程模式。</li>
<li>master进程的主要负责接受外部的信号，向worker进程发送信号，监控worker进程的运行状态以及在worker进程异常死亡时重启worker进程。而worker进程则主要负责网络事件的处理。多个worker进程之间通过锁机制竞争客户端发送给master进程的请求处理权。<h3 id="（三）处理流程"><a href="#（三）处理流程" class="headerlink" title="（三）处理流程"></a>（三）处理流程</h3></li>
<li>当我们通过nginx在80端口提供http服务时，master进程通过socket() -&gt; bind() -&gt; listen()创建监听套接字并绑定在80端口上监听客户端的连接请求，并通过fork()创建多个worker进程，这些worker()进程复制了master进程的虚拟地址空间，共享内核区进程控制块的文件描述符表，当有客户端向nginx服务发起连接请求时，多个worker进程共享的监听套接字会在这时变为可读状态，通过为了保证只有一个进程处理该请求，所有worker进程需要争抢accpet_mutex锁，抢到互斥锁的的进程负责处理监听套接字的读事件。</li>
<li>在worker进程获取了与客户端通信的权力后，便开始进行recv()，send()等一系列操作，最后断开与客户端通信的套接字，这就是一个请求从发起到结束的全部流程。nginx通过多进程的方式，将一个时间点内的多个请求分摊给多个worker处理，这多个worker进程绑定cpu不同核心，相比于单进程处理，多进程的处理方式对服务器性能做了极大的提升。</li>
</ul>
<h2 id="二．事件驱动架构"><a href="#二．事件驱动架构" class="headerlink" title="二．事件驱动架构"></a>二．事件驱动架构</h2><blockquote>
<p>nginx的事件驱动架构的核心是epoll，也是nginx得以获得高并发，高性能的关键因素，IO多路复用技术可以用来实现事件驱动模型，nginx使用的epoll就是IO多路复用技术之一，此外还有select与poll，与多进程多线程相比，IO多路复用技术的最大优势是系统开销小，不必创建维护进程/线程。下面通过分析三种不同的IO多路复用技术，探讨epoll的优势所在。</p>
</blockquote>
<h3 id="（一）select"><a href="#（一）select" class="headerlink" title="（一）select"></a>（一）select</h3><ul>
<li>select会构造一张文件描述符列表，需要我们手动添加要监听的文件描述符到表中，select内部会以遍历的形式检测被标识的文件描述符是否具有可读/可写/异常状态，当某个文件描述符具备这种状态的时候，select函数返回，我们通过读取传入文件描述符列表，就能够判断可处理文件描述符，进而进行相关IO操作。</li>
<li>select的缺点之一在于select函数的fdset大小为128字节，最大监听文件描述符数量为1024，修改系统内核也会造成效率的降低，其次select对文件描述符表采用轮询处理，即遍历处理，这样的效率是很低的。再有select需要在内核区和用户去频繁复制文件描述符集，使得系统开销变大。<h3 id="（二）poll"><a href="#（二）poll" class="headerlink" title="（二）poll"></a>（二）poll</h3></li>
<li>poll是对select的简单改进版，其对文件描述符集的遍历依旧是线性遍历，但是poll使用链表数据结构维护文件描述符集，这使得可检测的文件描述符数量突破了select函数1024的限制，可操作的文件描述符数量即为系统可以打开的最大文件描述符数量。还有一点优化在于用户无需每次调用poll时传入一个新的文件描述符集，因为poll对于传入文件描述符集的修改在结构体的revents上，其要检测事件events是不会被修改的。<h3 id="（三）epoll"><a href="#（三）epoll" class="headerlink" title="（三）epoll"></a>（三）epoll</h3></li>
<li>epoll相比于select和poll最大的改进在于epoll使用了红黑树+就绪链表的数据结构，可监听文件描述符数量与poll一样是系统可打开的最大文件描述符数。用户使用epoll_create函数会在内核创建一颗红黑树（用来维护用户关心的文件描述符），以及就绪链表（用来存放已经就绪的文件描述符）。接着用户执行epoll_ctl函数传入epoll_event结构体，该结构体会被拷贝进内核，内核会在红黑树上添加对应的节点。需要注意的是，内核对红黑树上可用文件描述符的检测依旧采用轮询处理，当发现某个文件描述符处于可用状态时，会调用该节点在epoll_ctl时注册的回调函数，将其添加进就绪链表当初，epoll_wait返回的文件描述符集只存在可用文件描述符，这使得用户在遍历该文件描述符集时省去了大量不可用文件描述符的事件。并且这里返回的文件描述符集通过mmap创建内核区和用户区的共享内存空间，减少了在内核区与用户区之间不必要的拷贝操作。其次epoll支持边沿触发工作模式，当事件发生时，用户必需立即处理完成，有效减少了事件触发次数。</li>
</ul>
<h3 id="（四）epoll与select、poll对比"><a href="#（四）epoll与select、poll对比" class="headerlink" title="（四）epoll与select、poll对比"></a>（四）epoll与select、poll对比</h3><ol>
<li>epoll减少了用户区和内核区之间的数据拷贝。<ul>
<li>使用select时需要创建fdset拷贝到内核中，在内核检测到就就绪事件后，修改传入fdset的标志位告知用户有就绪事件的发生，然后将fdset从内核区拷贝到用户区。内核区删除和文件描述符相关的数据结构，由于select修改了fdset的值，在下一次调用select时必需重置fdset，内核再重新拷贝一份新的文件描述符集。</li>
<li>调用poll时将pollfd结构体数组拷贝到内核区监听，内核分配链表来存储监听的文件描述符，检测到事件发生后修改fd对应的revents值用于告知用户，而events成员不变，因此下一次调用poll无需重置操作。然后内核把传入的pollfd传出到用户区，删除与文件描述符相关的数据结构，下次调用poll需要将pollfd重新传给内核，内核重新拷贝，重新分配数据结构。</li>
<li>调用epoll_create会在内核区创建红黑树和就绪链表，接着调用epoll_ctl将epoll_event结构体拷贝到内核区，内核在红黑树上添加对应节点，然后将就绪链表上的文件描述符传入epoll_event结构体数组返回用户区，系统在返回时使用内存映射函数mmap创建共享存储区，避免了从内核区到用户区的拷贝操作，且内核不会删除与文件描述符相关的数据结构，下一次epoll调用也就不需要再做用户区到内核区的拷贝操作，直接沿用之前的数据结构。</li>
</ul>
</li>
<li>epoll减少了对就绪文件描述符的遍历。<ul>
<li>需要注意的是，在内核的层面上，内核检测文件描述符集时，三者采用的都是轮询的操作，时间复杂度都为O(n)，唯一的区别在于epoll的红黑树上只维护了用户关心的文件描述符，而select则是维护了全部1024个文件描述符，poll则是维护用户传入的pollfd结构体数组。</li>
<li>而在用户层面上，epoll返回的是内核就绪链表中的文件描述符，这里面的文件描述符全部都是用户需要处理的，所以在用户层面上调用epoll的时间复杂度为O(1)，而selcet和poll返回的就是传入的文件描述符集，我们需要通过遍历去判断哪个文件描述符处于就绪状态，因此在调用select和poll的时候时间复杂度为O(n)。虽然select和poll都可以通过maxfd来做一定程度上的遍历优化，但依旧存在时间浪费问题。</li>
</ul>
</li>
<li>epoll支持et工作模式<ul>
<li>select和poll都是LT（水平触发）工作模式，而epoll默认采用LT工作模式，同样也支持ET（边沿触发）工作模式。并且同时支持block与no-block文件描述符。</li>
<li>LT工作模式即当内核检测到文件描述符集上有文件描述符处于就绪状态，就会通知用户，用户可以选择不处理或只处理一部分，下一次调用时内核依旧会通知用户该文件描述符处于就绪状态。</li>
<li>ET工作模式即当内核检测到文件描述符集上有文件描述符处于就绪状态，会通知用户但该文件描述符只被通知一次直到下一次新的就绪状态来临，因此用户必需立即处理完成该事件，所以对应的文件描述符必须设置非阻塞，避免在循环对文件描述符做读写操作时，因为操作完成而阻塞在读写操作上。ET工作模式很大程度上减少了文件描述符被重复触发的次数，因此效率比LT工作模式要高。</li>
<li>但是在epoll配合多线程使用时，一个文件描述符依旧有可能被触发多次，当一个线程在处理该文件描述符时，该文件描述符触发了新的就绪状态，这时另一个线程被通知处理该文件描述符，这就造成了两个线程同时操作一个文件描述符的问题。epoll对此问题提供了相应的EPOLLONESHOT事件，对于注册了EPOLLONESHOT的文件描述符，内核只触发该文件描述符的一个事件且只触发一次，只有在一个线程对该文件描述符的处理完成后，该线程会会重置该文件描述符上EPOLLONESHOT事件状态，使得该文件描述符再次处于可被触发状态。使用EPOLLONESHOT事件机制进一步减少了事件被触发的次数。</li>
</ul>
</li>
<li>epoll适用情形<ul>
<li>由于epoll在内核中维护了红黑树和就绪链表，且该数据结构不被删除可以重复利用，内核开销很大，如果只是监听少量的文件描述符，内核开销得不偿失，因此epoll适用于并发量大的情景。而且需要注意的是，当并发量较大时，就绪文件描述符拷贝到就绪列表的操作太大，对服务器来讲是不小的压力，这也是epoll相比于select和poll的不足之处。</li>
</ul>
</li>
</ol>
<h2 id="三．同步与异步"><a href="#三．同步与异步" class="headerlink" title="三．同步与异步"></a>三．同步与异步</h2><ul>
<li><p>同步异步与阻塞非阻塞常常被同时提起，由于nginx使用epoll-et作为事件驱动模型，使得通信套接字为非阻塞状态，那么为什么说nginx是同步IO模型呢？</p>
</li>
<li><p>上文提到epoll在内核层面上通过轮询的方式，寻找处于就绪状态的文件描述符，当寻找到时将该文件描述符添加到就绪链表当中，这个添加过程用到了红黑树在节点添加时注册的回调函数，通过该回调函数为就绪链表添加就绪状态文件描述符。而在用户层面，遍历epoll_event结构体数组处理所有处于就绪状态的文件描述符。</p>
</li>
<li><p>有POSIX对异步IO和同步IO的定义：</p>
<blockquote>
<p>An asynchronous I/O operation does not cause the requesting process to be blocked; （异步IO操作不会导致请求进程被阻塞）<br>A synchronous I/O operation causes the requesting process to be blocked until that I/O operation completes;（同步IO操作导致请求过程被阻塞，直到该IO操作完成）</p>
</blockquote>
</li>
<li><p>而对于处于就绪状态文件描述符的IO操作在用户区进行，在遍历就绪文件描述符数组时，对相应的文件描述符做IO操作，这个过程时阻塞的，只有所有的IO操作进行完，进程才可以做后续操作。需要注意的是，这里的阻塞不是指文件描述符的阻塞/非阻塞状态，文件描述符在epoll-et模式下，被设置为非阻塞。但是进程必须等待就绪文件描述符的IO操作结束，这个过程是阻塞的，该阻塞状态持续到IO操作完成。符合POSIX对于同步IO的定义。</p>
</li>
<li><p>那为什么在有些资料中说nginx是多进程+异步非阻塞呢？这个异步操作到底体现在哪里呢？对于内核层面，调用epoll_ctl函数添加红黑树节点时，会为该文件描述符注册回调函数，当轮询红黑树节点发现某个节点处于就绪状态时，调用对应的回调函数将该文件描述符添加到就绪链表。但这个过程并不是异步回调，轮询操作必须等待回调函数完成才能够继续进行。至于“异步”大体指的是编程模型上的异步概念，指文件描述符就绪状态的轮询判定与就绪状态的处理是异步关系，并非真正的异步IO。</p>
</li>
</ul>
<h2 id="四．总结"><a href="#四．总结" class="headerlink" title="四．总结"></a>四．总结</h2><ul>
<li>异步IO的效率毫无疑问是高于同步IO的，那我们有没有可能对nginx现有的架构做进一步的优化，使其真正支持异步IO通信呢？epoll在内核层面采用了回调机制，在C语言中，回调是处理异步IO操作的一种简捷的方式，但需要配合多线程的使用，但是使用多线程需要创建并维护线程，线程之间上下文的切换也需要额外的开销，这对于在高并发情形下本就不轻松的内核来说，无异于是更大的负担。而对于用户区来说，亦没有必要采用多线程的方式对就绪状态文件描述符做IO操作，由于所有的文件描述符都是就绪的，在整个遍历处理的过程中，没有阻塞状态，也就没有对cpu资源的浪费行为，前面也已经提到过nginx的整体工作流程是采用多进程的方式，对cpu资源已经达到了最大程度的利用，我们再去使用多线程处理只会增加内核的负担。也就是说，nginx现有的架构已经是再多种并发模型权衡下的最优选择，但在最新的C++20标准中为C++引入了协程，C++中的协程具备夸张的性能优势，或许在未来会出现基于现有nginx架构，使用C++协程实现真正的多进程+异步非阻塞模型也极有可能。</li>
</ul>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>李素晴</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://lisuqing2020.github.io/2020/04/18/other/nginx%E5%88%86%E6%9E%90/" title="nginx分析">http://lisuqing2020.github.io/2020/04/18/other/nginx%E5%88%86%E6%9E%90/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless stating additionally.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/04/25/record/%E9%9B%B7%E7%81%AB4.25%E7%AC%94%E8%AF%95/" rel="prev" title="雷火25笔试"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">雷火25笔试</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/04/16/other/nginx%E6%98%AF%E5%90%8C%E6%AD%A5%E7%9A%84!/" rel="next" title="nginx是同步的!"><span class="post-nav-text">nginx是同步的!</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/lisuqing2020/lisuqing2020.github.io/issues?q=is:issue+nginx分析">GitHub Issues</a></div><div id="valine-container"></div><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function initValine() {
  const valineConfig = {"enable":true,"appId":null,"appKey":null,"placeholder":"你看一晃两三年，匆匆又夏天","avatar":null,"pageSize":10,"visitor":false,"highlight":true,"recordIP":false,"enableQQ":true,"appid":"p14aECEQvrlk4brHLOn0nij4-gzGzoHsz","appkey":"J93LFcbKRj9xFjUo40L5y1sj","meta":["nick","mail","link"],"el":"#valine-container","lang":"en"}
  valineConfig.path = window.location.pathname
  new Valine(valineConfig)
}
setTimeout(initValine, 1000)</script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 李素晴</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.1.1</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.2.0</span></div><div id="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv" title="Total Visitors"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="Total Views"><span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg></span><span id="busuanzi_value_site_pv"></span></span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div id="local-search-result"></div></div></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>